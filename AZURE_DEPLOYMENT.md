# Azure VM Deployment Guide

Complete guide for deploying sql2doc to an Azure Virtual Machine.

---

## Prerequisites

- Azure account with active subscription
- Azure CLI installed locally (optional, for automation)
- SSH key pair for VM access
- Git repository (GitHub/Azure DevOps/GitLab)

---

## Step 1: Create Azure VM

### Option A: Azure Portal (GUI)

1. **Go to Azure Portal:** https://portal.azure.com
2. **Create Virtual Machine:**
   - Click "Create a resource" → "Virtual Machine"
   - **Basics:**
     - Subscription: Select your subscription
     - Resource Group: Create new or use existing
     - VM Name: `sql2doc-vm`
     - Region: Choose closest region
     - Image: **Ubuntu Server 22.04 LTS**
     - Size: **Standard_B2s** (2 vCPUs, 4 GB RAM) - minimum
       - Recommended: **Standard_D2s_v3** (2 vCPUs, 8 GB RAM)
     - Authentication: SSH public key
     - Username: `azureuser`
     - SSH public key: Upload or paste your public key

   - **Disks:**
     - OS disk type: **Standard SSD**
     - Size: 30 GB minimum (50 GB recommended)

   - **Networking:**
     - Virtual network: Create new or use existing
     - Public IP: Yes
     - NIC network security group: **Basic**
     - Public inbound ports:
       - ✅ SSH (22)
       - ✅ HTTP (80)
       - ✅ HTTPS (443)
       - ✅ Custom: 8501 (Streamlit)

   - **Management:**
     - Enable auto-shutdown: Optional (recommended for dev)
     - Notification: Your email

3. **Review + Create** → Click "Create"
4. **Download SSH private key** (if generated by Azure)
5. **Wait for deployment** (2-3 minutes)
6. **Copy Public IP Address** from VM overview

### Option B: Azure CLI (Automated)

```bash
# Login to Azure
az login

# Set variables
RESOURCE_GROUP="sql2doc-rg"
VM_NAME="sql2doc-vm"
LOCATION="eastus"
VM_SIZE="Standard_B2s"
IMAGE="Ubuntu2204"

# Create resource group
az group create --name $RESOURCE_GROUP --location $LOCATION

# Create VM
az vm create \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --image $IMAGE \
  --size $VM_SIZE \
  --admin-username azureuser \
  --generate-ssh-keys \
  --public-ip-sku Standard

# Open ports
az vm open-port --port 22 --resource-group $RESOURCE_GROUP --name $VM_NAME --priority 100
az vm open-port --port 80 --resource-group $RESOURCE_GROUP --name $VM_NAME --priority 101
az vm open-port --port 443 --resource-group $RESOURCE_GROUP --name $VM_NAME --priority 102
az vm open-port --port 8501 --resource-group $RESOURCE_GROUP --name $VM_NAME --priority 103

# Get public IP
az vm show --resource-group $RESOURCE_GROUP --name $VM_NAME -d --query publicIps -o tsv
```

---

## Step 2: Connect to VM

```bash
# SSH into the VM
ssh azureuser@<PUBLIC_IP>

# Example:
ssh azureuser@20.185.123.45
```

---

## Step 3: Initial VM Setup

Run these commands on the VM:

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install essential tools
sudo apt install -y git curl wget vim htop

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install Docker Compose
sudo apt install -y docker-compose

# Logout and login again for docker group to take effect
exit
# SSH back in
ssh azureuser@<PUBLIC_IP>

# Verify Docker
docker --version
docker-compose --version
```

---

## Step 4: Setup Git Repository

### Option A: Clone from Existing Repository

```bash
# Clone your repository
cd ~
git clone https://github.com/thedataengineer/sql2doc.git
cd sql2doc
```

### Option B: Push Local Code to New Repository

**On your local machine:**

```bash
cd /Users/karteek/dev/personal/experiments/experiment/sql2doc

# Create new repository on GitHub/GitLab/Azure DevOps first, then:

# Add remote (replace with your repo URL)
git remote add azure https://github.com/yourusername/sql2doc.git

# Or if using Azure DevOps:
git remote add azure https://dev.azure.com/yourorg/yourproject/_git/sql2doc

# Push to remote
git push -u azure main
```

**Then on VM:**

```bash
cd ~
git clone https://github.com/thedataengineer/sql2doc.git
cd sql2doc
```

---

## Step 5: Deploy with Docker Compose

The easiest way to deploy everything:

```bash
cd ~/sql2doc

# Start all services
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f

# Access application
# Open browser: http://<PUBLIC_IP>:8501
```

---

## Step 6: Manual Setup (Alternative)

If you prefer not to use Docker Compose:

```bash
cd ~/sql2doc

# Install Python and dependencies
sudo apt install -y python3-pip python3-venv

# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Install Ollama (for AI features)
curl https://ollama.ai/install.sh | sh

# Pull Llama model
ollama pull llama3.2

# Start Ollama service
ollama serve &

# Start PostgreSQL with Docker
docker run --name postgres_legal \
  -e POSTGRES_PASSWORD=legal_collections_pass \
  -e POSTGRES_USER=legal_admin \
  -p 5432:5432 \
  -d postgres:15

# Wait for PostgreSQL to start
sleep 10

# Load test database
PGPASSWORD=legal_collections_pass psql -h localhost -U legal_admin -d postgres \
  -f test_data/legal_collections_schema.sql

PGPASSWORD=legal_collections_pass psql -h localhost -U legal_admin -d legal_collections_db \
  -f test_data/legal_collections_procedures.sql

PGPASSWORD=legal_collections_pass psql -h localhost -U legal_admin -d legal_collections_db \
  -f test_data/legal_collections_sample_data.sql

# Run Streamlit
streamlit run app.py --server.port 8501 --server.address 0.0.0.0
```

---

## Step 7: Setup as System Service

Create systemd service for automatic startup:

```bash
# Create service file
sudo nano /etc/systemd/system/sql2doc.service
```

Paste this content:

```ini
[Unit]
Description=SQL2Doc Streamlit Application
After=network.target docker.service
Requires=docker.service

[Service]
Type=simple
User=azureuser
WorkingDirectory=/home/azureuser/sql2doc
Environment="PATH=/home/azureuser/sql2doc/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/azureuser/sql2doc/venv/bin/streamlit run app.py --server.port 8501 --server.address 0.0.0.0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start the service:

```bash
# Reload systemd
sudo systemctl daemon-reload

# Enable service (start on boot)
sudo systemctl enable sql2doc

# Start service
sudo systemctl start sql2doc

# Check status
sudo systemctl status sql2doc

# View logs
sudo journalctl -u sql2doc -f
```

---

## Step 8: Setup Nginx Reverse Proxy (Optional but Recommended)

For production deployment with HTTPS:

```bash
# Install Nginx
sudo apt install -y nginx

# Create Nginx configuration
sudo nano /etc/nginx/sites-available/sql2doc
```

Paste this content:

```nginx
server {
    listen 80;
    server_name your-domain.com;  # Replace with your domain or use IP

    location / {
        proxy_pass http://localhost:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

Enable the site:

```bash
# Enable site
sudo ln -s /etc/nginx/sites-available/sql2doc /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx

# Now access via: http://<PUBLIC_IP>
```

---

## Step 9: Setup SSL with Let's Encrypt (Optional)

For HTTPS with free SSL certificate:

```bash
# Install certbot
sudo apt install -y certbot python3-certbot-nginx

# Get certificate (replace with your domain)
sudo certbot --nginx -d your-domain.com

# Certbot will automatically configure Nginx for HTTPS
# Certificate auto-renews every 90 days

# Test renewal
sudo certbot renew --dry-run

# Now access via: https://your-domain.com
```

---

## Step 10: Firewall Configuration

Configure Azure Network Security Group (NSG):

```bash
# Via Azure CLI
RESOURCE_GROUP="sql2doc-rg"
NSG_NAME="sql2doc-vmNSG"

# Allow Streamlit
az network nsg rule create \
  --resource-group $RESOURCE_GROUP \
  --nsg-name $NSG_NAME \
  --name AllowStreamlit \
  --priority 104 \
  --source-address-prefixes '*' \
  --destination-port-ranges 8501 \
  --protocol Tcp \
  --access Allow

# Or configure in Azure Portal:
# VM → Networking → Add inbound port rule
```

---

## Deployment Checklist

- [ ] Azure VM created and running
- [ ] SSH access working
- [ ] Docker installed
- [ ] Git repository cloned
- [ ] Docker Compose running (or manual setup)
- [ ] PostgreSQL database loaded
- [ ] Streamlit application accessible
- [ ] Firewall ports opened (22, 80, 443, 8501)
- [ ] Systemd service configured (optional)
- [ ] Nginx reverse proxy setup (optional)
- [ ] SSL certificate installed (optional)

---

## Access URLs

After deployment:

- **Direct Streamlit:** `http://<PUBLIC_IP>:8501`
- **Via Nginx:** `http://<PUBLIC_IP>`
- **With SSL:** `https://your-domain.com`

---

## Monitoring and Maintenance

### Check Application Status

```bash
# Docker Compose
docker-compose ps
docker-compose logs -f streamlit

# Systemd service
sudo systemctl status sql2doc
sudo journalctl -u sql2doc -f

# Check processes
ps aux | grep streamlit
```

### Update Application

```bash
cd ~/sql2doc

# Pull latest changes
git pull

# Restart services
docker-compose restart

# Or systemd
sudo systemctl restart sql2doc
```

### Database Backup

```bash
# Backup PostgreSQL
docker exec postgres_legal pg_dump -U legal_admin legal_collections_db > backup_$(date +%Y%m%d).sql

# Copy to Azure Blob Storage (optional)
az storage blob upload \
  --account-name yourstorageaccount \
  --container-name backups \
  --name backup_$(date +%Y%m%d).sql \
  --file backup_$(date +%Y%m%d).sql
```

---

## Troubleshooting

### Cannot connect to VM
```bash
# Check VM is running
az vm get-instance-view --resource-group sql2doc-rg --name sql2doc-vm --query instanceView.statuses[1]

# Check NSG rules
az network nsg rule list --resource-group sql2doc-rg --nsg-name sql2doc-vmNSG -o table
```

### Streamlit not accessible
```bash
# Check if running
docker-compose ps
sudo systemctl status sql2doc

# Check port
sudo netstat -tlnp | grep 8501

# Check logs
docker-compose logs streamlit
sudo journalctl -u sql2doc -f
```

### Database connection issues
```bash
# Check PostgreSQL
docker ps | grep postgres
docker logs postgres_legal

# Test connection
docker exec -it postgres_legal psql -U legal_admin -d legal_collections_db
```

---

## Cost Estimate

### Azure VM Pricing (Pay-as-you-go)

**Standard_B2s (2 vCPUs, 4 GB RAM):**
- ~$40-50/month (with 730 hours)
- Best for: Development/Testing

**Standard_D2s_v3 (2 vCPUs, 8 GB RAM):**
- ~$70-90/month (with 730 hours)
- Best for: Production (light load)

**Tips to reduce costs:**
- Enable auto-shutdown for dev environments
- Use Azure Reserved Instances (up to 72% savings)
- Use Spot VMs for dev/test (up to 90% savings)

---

## Security Best Practices

1. **SSH Key Authentication Only**
   - Disable password authentication
   - Use strong SSH keys (4096-bit RSA)

2. **Firewall Rules**
   - Restrict SSH (port 22) to your IP only
   - Use Azure NSG for defense in depth

3. **Keep System Updated**
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

4. **Use Secrets Management**
   - Store passwords in Azure Key Vault
   - Use managed identities where possible

5. **Enable Monitoring**
   - Azure Monitor for VM metrics
   - Log Analytics for centralized logging

6. **Regular Backups**
   - Database backups to Azure Blob Storage
   - VM snapshots (optional)

---

## Next Steps

1. Deploy to Azure VM using this guide
2. Test all features
3. Configure custom domain (optional)
4. Setup monitoring and alerts
5. Implement backup strategy
6. Document any custom configurations

---

## Support

For issues:
- Check logs: `docker-compose logs` or `sudo journalctl -u sql2doc`
- Review Azure VM diagnostics in portal
- Check network connectivity and NSG rules